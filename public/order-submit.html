<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Order - Investment Game</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="panel">
        <h1>Submit Order</h1>
        <div id="orderForm">
            <div class="form-group">
                <label for="playerName">Player Name:</label>
                <input type="text" id="playerName" required>
            </div>
            
            <div class="form-group">
                <label for="orderType">Order Type:</label>
                <select id="orderType" required>
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="fundSelect">Fund:</label>
                <select id="fundSelect" required></select>
            </div>
            
            <div class="form-group">
                <label for="shares">Number of Shares:</label>
                <input type="number" id="shares" min="1" value="1" required>
            </div>
            
            <button onclick="submitOrder()">Submit Order</button>
        </div>
        
        <div id="status" style="margin-top: 20px;"></div>
    </div>

    <script src="js/socket-client.js"></script>
    <script>
        // Game state
        let gameState = {
            funds: [],
            phase: 'Markets Closed'
        };

        // Initialize WebSocket connection
        let socket = createSocketConnection('player');
        
        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'initialData':
                    gameState = data;
                    updateUI();
                    break;
                case 'fundsUpdate':
                    gameState.funds = data.funds;
                    updateFundsList();
                    break;
                case 'phaseUpdate':
                    gameState.phase = data.phase;
                    break;
                case 'orderResponse':
                    handleOrderResponse(data);
                    break;
            }
        }

        // Add window focus handler to reconnect if needed
        window.onfocus = () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                console.log('Window focused, checking connection...');
                socket = createSocketConnection('player');
            }
        };

        // Update UI with current game state
        function updateUI() {
            updateFundsList();
        }

        // Update funds list in dropdown
        function updateFundsList() {
            const fundSelect = document.getElementById('fundSelect');
            fundSelect.innerHTML = gameState.funds.map(fund => 
                `<option value="${fund.id}">${fund.name} ($${fund.price.toFixed(2)})</option>`
            ).join('');
        }

        // Submit order
        function submitOrder() {
            const playerName = document.getElementById('playerName').value.trim();
            const orderType = document.getElementById('orderType').value;
            const fundId = document.getElementById('fundSelect').value;
            const shares = parseInt(document.getElementById('shares').value);
            
            if (!playerName || !orderType || !fundId || !shares) {
                updateStatus('Please fill in all fields', 'error');
                return;
            }
            
            const order = {
                playerName: playerName,
                orderType: orderType,
                fundId: fundId,
                shares: shares
            };
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'order',
                    order: order
                }));
                updateStatus('Order submitted, waiting for confirmation...');
            } else {
                updateStatus('Not connected to server', 'error');
            }
        }

        // Handle order response
        function handleOrderResponse(data) {
            if (data.success) {
                updateStatus('Order submitted successfully!', 'success');
                // Clear form
                document.getElementById('shares').value = '1';
            } else {
                updateStatus(data.message || 'Order submission failed', 'error');
            }
        }

        // Update status message
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status-' + type;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeWebSocket();
        });
    </script>
</body>
</html> 