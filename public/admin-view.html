<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Game - Admin View</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .admin-header {
            background-color: #d81b60;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .form-links {
            background-color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .form-link {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .form-link input {
            flex-grow: 1;
        }
        
        .form-link button {
            margin-left: 10px;
        }
        
        .admin-notice {
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 15px 0;
            color: #c62828;
            font-weight: bold;
        }

        /* Price change styles */
        .price-up {
            color: #4caf50;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .price-down {
            color: #f44336;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .fund-price {
            transition: color 0.3s ease;
        }

        /* Fund item styles */
        .fund-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .fund-item:last-child {
            border-bottom: none;
        }

        .fund-name {
            font-weight: bold;
        }

        /* Add these styles */
        .phase-display {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 0 10px;
        }
        
        .closed-phase {
            background-color: #f44336;
            color: white;
        }
        
        .trading-open-phase {
            background-color: #4caf50;
            color: white;
        }
        
        .phase-button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .phase-button:hover {
            background-color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>Investment Game - ADMIN VIEW</h1>
        <div class="admin-notice">
            This is your admin view. Use the public-view.html page for display on the TV.
        </div>
    </div>
    
    <div class="form-links">
        <h2>Google Form URLs</h2>
        <p>Create two Google Forms: one for buying and one for selling. Paste the URLs below and click "Update QR Codes" to update them on the public view.</p>
        
        <div class="form-link">
            <label>Buy Orders Form URL:</label>
            <input type="text" id="buyFormUrl" placeholder="Paste your Google Form URL for buying">
        </div>
        
        <div class="form-link">
            <label>Sell Orders Form URL:</label>
            <input type="text" id="sellFormUrl" placeholder="Paste your Google Form URL for selling">
        </div>
        
        <button id="updateQrBtn" class="primary-btn">Update QR Codes on Public View</button>
    </div>
    
    <div class="panel">
        <h2>Game Controls</h2>
        <button id="startButton">Start Game</button>
        <span id="gameStatus">Status: Setup Mode</span>
        <span id="gameMode" class="game-mode setup-mode">SETUP MODE</span>
        <div id="setupNotice" class="notice">
            During setup, players can build initial portfolios without affecting prices. Fund prices will begin to fluctuate once the game starts.
        </div>
    </div>
    
    <div class="panel" id="phasePanel">
        <h2>Market Status</h2>
        <div class="phase-info">
            <div class="phase-label">Current Phase: <span id="phaseDisplay" class="phase-display closed-phase">Markets Closed</span></div>
            <button id="phaseButton" class="phase-button">Open Trading</button>
        </div>
    </div>
    
    <div class="panel">
        <h2>Add Player</h2>
        <input type="text" id="playerNameInput" placeholder="Player Name">
        <button id="addPlayerButton">Add Player</button>
    </div>
    
    <div class="panel">
        <h2>Buy Shares</h2>
        <select id="buyPlayerSelect"></select>
        <select id="buyFundSelect"></select>
        <input type="number" id="buySharesInput" value="1" min="1">
        <button id="buyButton">Buy</button>
        <div id="buyingNotice" class="phase-notice">Buy orders can only be placed during Buying Period</div>
    </div>
    
    <div class="panel">
        <h2>Sell Shares</h2>
        <select id="sellPlayerSelect"></select>
        <select id="sellFundSelect"></select>
        <input type="number" id="sellSharesInput" value="1" min="1">
        <button id="sellButton">Sell</button>
        <div id="sellingNotice" class="phase-notice">Sell orders can only be placed during Selling Period</div>
    </div>
    
    <div class="panel">
        <h2>Pending Transactions</h2>
        <div id="transactionButtons" class="transaction-controls" style="display: none;">
            <button id="processNextBtn" class="process-button">Process Next Order</button>
            <button id="processAllBtn" class="process-button-all">Process All Orders</button>
        </div>
        <div id="pendingTransactions" class="pending-container">
            <div class="no-pending">No pending transactions</div>
        </div>
    </div>
    
    <div class="panel">
        <h2>Funds <span id="marketStatus" class="market-status" style="display: none;">ACTIVE</span></h2>
        <div class="market-notice" id="marketNotice">
            Market prices are frozen during buying and selling periods, and only fluctuate during "Markets Closed" phase.
        </div>
        <div id="fundsList"></div>
    </div>
    
    <div class="panel">
        <h2>Players</h2>
        <div id="playersList"></div>
    </div>
    
    <div class="panel">
        <h2>Log</h2>
        <div id="log" class="log"></div>
        
    </div>

    <div class="panel">
        <h2>Market Events</h2>
        <div class="event-buttons">
            <h3>Trump Coin</h3>
            <button onclick="triggerMarketEvent('trump_executive_order')" class="event-button positive">Trump Executive Order (+40%)</button>
            <button onclick="triggerMarketEvent('trump_rug_pull')" class="event-button negative">Rug Pull (-90%)</button>
            
            <h3>Checkpoint Therapeutics</h3>
            <button onclick="triggerMarketEvent('checkpoint_fda_rejection')" class="event-button negative">FDA Rejection (-35%)</button>
            
            <h3>Boeing Co.</h3>
            <button onclick="triggerMarketEvent('boeing_no_chairs')" class="event-button positive">No Chairs (+30%)</button>
            <button onclick="triggerMarketEvent('boeing_doors_off')" class="event-button negative">Doors Fall Off (-20%)</button>
            
            <h3>Luigi Mangione Legal Fund</h3>
            <button onclick="triggerMarketEvent('luigi_green_sweater')" class="event-button positive">Green Sweater (+69%)</button>
            
            <h3>Taylor Swift's Eras Tour Treasury</h3>
            <button onclick="triggerMarketEvent('taylor_new_dates')" class="event-button positive">New Tour Dates (+40%)</button>
            <button onclick="triggerMarketEvent('taylor_engagement')" class="event-button negative">Engagement Rumors (-25%)</button>
        </div>
    </div>
    
    <!-- Load JavaScript files -->
    <script src="js/socket-client.js?v=2"></script>
    <script src="js/game.js"></script>
    <script src="js/funds.js"></script>
    <script src="js/players.js"></script>
    <script src="js/transactions.js"></script>
    <script src="js/phases.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/data-sharing.js"></script>
    <script>
        // Game state
        let gameState = {
            phase: 'Markets Closed',
            timeRemaining: 60,
            funds: [],
            players: [],
            pendingMarketImpacts: []
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Document loaded, initializing admin view");
            
            // Initialize WebSocket connection
            if (typeof createSocketConnection !== 'function') {
                console.error('socket-client.js not loaded properly');
                return;
            }
            
            console.log('Initializing WebSocket connection...');
            initializeWebSocketConnection();
        });

        function initializeWebSocketConnection() {
            // Create socket connection
            socket = createSocketConnection('admin');
            
            if (!socket) {
                console.error('Failed to create WebSocket connection');
                setTimeout(initializeWebSocketConnection, 1000); // Retry after 1 second
                return;
            }

            // Wait for WebSocket connection before initializing
            onConnectionReady(() => {
                console.log("WebSocket connected, initializing admin view");
                
                // Initialize the game
                initializePhases();
                
                // Make sure buy and sell buttons are enabled during setup
                document.getElementById('buyButton').disabled = false;
                document.getElementById('sellButton').disabled = false;
                
                // Hide market status initially
                document.getElementById('marketStatus').style.display = 'none';
                
                // Add event listeners
                document.getElementById('startButton').addEventListener('click', startGame);
                document.getElementById('addPlayerButton').addEventListener('click', addPlayer);
                document.getElementById('buyButton').addEventListener('click', buyShares);
                document.getElementById('sellButton').addEventListener('click', sellShares);
                
                console.log("Admin view initialized in setup mode");
            });
        }
        
        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            console.log('Received WebSocket message:', data);
            switch(data.type) {
                case 'initialData':
                    gameState = data;
                    updateUI();
                    break;
                case 'fundsUpdate':
                    gameState.funds = data.funds;
                    updateFundsList();
                    break;
                case 'playerUpdate':
                    handlePlayerUpdate(data.player);
                    break;
                case 'phaseUpdate':
                    gameState.phase = data.phase;
                    gameState.timeRemaining = data.timeRemaining;
                    updatePhaseDisplay();
                    break;
                case 'newOrder':
                    handleNewOrder(data.order);
                    break;
            }
        }

        // Update UI with current game state
        function updateUI() {
            console.log('Updating UI with game state:', gameState);
            updateFundsList(gameState.funds);
            updatePlayersList();
            updatePhaseDisplay();
        }

        // Add QR code updating function
        document.getElementById('updateQrBtn').addEventListener('click', function() {
            const buyUrl = document.getElementById('buyFormUrl').value.trim();
            const sellUrl = document.getElementById('sellFormUrl').value.trim();
            
            if (buyUrl) localStorage.setItem('buyFormUrl', buyUrl);
            if (sellUrl) localStorage.setItem('sellFormUrl', sellUrl);
            
            alert('QR codes updated on public view!');
        });

        // Add window focus handler to reconnect if needed
        window.onfocus = () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                console.log('Window focused, checking connection...');
                socket = createSocketConnection('admin');
            }
        };

        // Modify startGame to enable data sharing
        const originalStartGame = startGame;
        startGame = function() {
            originalStartGame.apply(this, arguments);
            
            // Start data sharing when game starts
            if (gameMode === GAME_MODE.RUNNING) {
                startDataSharing();
            } else if (gameMode === GAME_MODE.ENDED) {
                stopDataSharing();
            }
        };

        // Update phase information
        function updatePhaseInfo(phase, timeRemaining) {
            console.log('Updating phase info:', { phase, timeRemaining });
            const phaseDisplay = document.getElementById('phaseDisplay');
            const phaseTimer = document.getElementById('phaseTimer');
            if (phaseDisplay) phaseDisplay.textContent = phase;
            if (phaseTimer) phaseTimer.textContent = timeRemaining + 's';
            
            // Update order type options based on phase
            const orderType = document.getElementById('orderType');
            if (orderType) {
                if (phase === 'Buying') {
                    orderType.value = 'buy';
                    orderType.disabled = true;
                } else if (phase === 'Selling') {
                    orderType.value = 'sell';
                    orderType.disabled = true;
                } else {
                    orderType.disabled = false;
                }
            }
            console.log('Phase info updated');
        }

        // Update funds list
        function updateFundsList(funds) {
            if (!funds) {
                console.warn('No funds data provided to updateFundsList');
                return;
            }
            console.log('Updating funds list:', funds);
            
            // Store previous prices before updating
            const previousPrices = {};
            if (gameState.funds) {
                gameState.funds.forEach(fund => {
                    previousPrices[fund.id] = fund.price;
                });
            }
            
            gameState.funds = funds;
            
            // Update all fund select elements
            const fundSelects = document.querySelectorAll('select[id$="FundSelect"]');
            fundSelects.forEach(select => {
                select.innerHTML = funds.map(fund => 
                    `<option value="${fund.id}">${fund.name} ($${fund.price.toFixed(2)})</option>`
                ).join('');
            });
            
            // Update funds list display
            const fundsList = document.getElementById('fundsList');
            if (fundsList) {
                fundsList.innerHTML = funds.map(fund => {
                    const previousPrice = previousPrices[fund.id] || fund.price;
                    const priceChange = fund.price - previousPrice;
                    const colorClass = priceChange > 0 ? 'price-up' : priceChange < 0 ? 'price-down' : '';
                    const arrow = priceChange > 0 ? '↑' : priceChange < 0 ? '↓' : '';
                    
                    return `
                        <div class="fund-item">
                            <span class="fund-name">${fund.name}</span>
                            <span class="fund-price ${colorClass}">
                                $${fund.price.toFixed(2)} ${arrow}
                                ${Math.abs(priceChange) > 0 ? ` (${(priceChange > 0 ? '+' : '')}${priceChange.toFixed(2)})` : ''}
                            </span>
                        </div>
                    `;
                }).join('');
            }
            
            console.log('Funds list updated');
        }

        // Get fund name from ID
        function getFundName(fundId) {
            const fund = gameState.funds.find(f => f.id === fundId);
            return fund ? fund.name : 'Unknown Fund';
        }

        // Handle new order
        function handleNewOrder(order) {
            console.log('\n=== Handling New Order ===');
            console.log('Order details:', order);
            
            const pendingContainer = document.getElementById('pendingTransactions');
            console.log('Found pending container:', pendingContainer);
            
            if (!pendingContainer) {
                console.error('Pending transactions container not found!');
                return;
            }
            
            // Validate order object
            if (!order || !order.playerName || !order.fundId || !order.shares) {
                console.error('Invalid order object:', order);
                return;
            }
            
            // Ensure orderType exists and is valid
            const orderType = (order.orderType || 'buy').toLowerCase();
            if (orderType !== 'buy' && orderType !== 'sell') {
                console.error('Invalid order type:', orderType);
                return;
            }
            
            // Remove "No pending transactions" message if it exists
            const noPending = pendingContainer.querySelector('.no-pending');
            if (noPending) {
                noPending.remove();
            }
            
            const transactionDiv = document.createElement('div');
            transactionDiv.className = 'transaction';
            transactionDiv.innerHTML = `
                <div class="transaction-info">
                    <span class="player-name">${order.playerName}</span>
                    <span class="order-type">${orderType.toUpperCase()}</span>
                    <span class="fund-name">${getFundName(order.fundId)}</span>
                    <span class="shares">${order.shares} shares</span>
                </div>
                <div class="transaction-actions">
                    <button onclick="processOrder('${order.playerName}', '${orderType}', '${order.fundId}', ${order.shares})">Process</button>
                    <button onclick="rejectOrder('${order.playerName}')">Reject</button>
                </div>
            `;
            
            pendingContainer.appendChild(transactionDiv);
            console.log('Added transaction to pending container');
            console.log('=== End Handling New Order ===\n');
        }

        // Process order
        function processOrder(playerName, orderType, fundId, shares) {
            console.log('Processing order:', { playerName, orderType, fundId, shares });
            
            // Get the fund price
            const fund = gameState.funds.find(f => f.id === fundId);
            if (!fund) {
                console.error('Fund not found:', fundId);
                return;
            }
            
            // Calculate total cost
            const totalCost = fund.price * shares;
            
            // Get or create player
            let player = getOrCreatePlayer(playerName);
            if (!player) {
                console.error('Could not get or create player:', playerName);
                return;
            }
            
            // Process the order
            if (orderType === 'buy') {
                // Check if player has enough money
                if (player.money < totalCost) {
                    console.error('Player does not have enough money');
                    return;
                }
                // Update player's money and shares
                player.money -= totalCost;
                player.shares[fundId] = (player.shares[fundId] || 0) + shares;
            } else if (orderType === 'sell') {
                // Check if player has enough shares
                if (!player.shares[fundId] || player.shares[fundId] < shares) {
                    console.error('Player does not have enough shares');
                    return;
                }
                // Update player's money and shares
                player.money += totalCost;
                player.shares[fundId] -= shares;
            }
            
            // Remove the transaction from pending
            const pendingContainer = document.getElementById('pendingTransactions');
            const transactions = pendingContainer.getElementsByClassName('transaction');
            for (let transaction of transactions) {
                if (transaction.querySelector('.player-name').textContent === playerName) {
                    transaction.remove();
                    break;
                }
            }
            
            // Update the UI
            updatePlayersList();
            
            // Broadcast player update to all clients
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'playerUpdate',
                    player: player
                }));
            }
            
            // Add to log
            addToLog(`${playerName} ${orderType}ed ${shares} shares of ${getFundName(fundId)}`);
            
            console.log('Order processed successfully');
        }

        // Reject order
        function rejectOrder(playerName) {
            console.log('Rejecting order for player:', playerName);
            // Remove the transaction from pending
            const pendingContainer = document.getElementById('pendingTransactions');
            const transactions = pendingContainer.getElementsByClassName('transaction');
            for (let transaction of transactions) {
                if (transaction.querySelector('.player-name').textContent === playerName) {
                    transaction.remove();
                    break;
                }
            }
            // TODO: Notify player of rejection
            console.log('Order rejected');
        }

        // Update phase
        function updatePhase(phase, timeRemaining) {
            console.log('Updating phase:', { phase, timeRemaining });
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'updatePhase',
                    phase: phase,
                    timeRemaining: timeRemaining
                }));
            } else {
                console.warn('WebSocket not connected, attempting to reconnect...');
                // Create new connection and wait for it to be ready
                socket = createSocketConnection('admin');
                onConnectionReady(() => {
                    console.log('WebSocket reconnected, sending phase update');
                    socket.send(JSON.stringify({
                        type: 'updatePhase',
                        phase: phase,
                        timeRemaining: timeRemaining
                    }));
                });
            }
        }

        // Update funds
        function updateFunds(funds) {
            console.log('Updating funds:', funds);
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'updateFunds',
                    funds: funds
                }));
            } else {
                console.warn('WebSocket not connected, cannot update funds');
            }
        }

        // Add to log function
        function addToLog(message) {
            const log = document.getElementById('log');
            if (log) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                log.insertBefore(entry, log.firstChild);
            }
        }

        // Get or create player
        function getOrCreatePlayer(playerName) {
            // Try to find existing player
            let player = gameState.players.find(p => p.name === playerName);
            
            // If player doesn't exist, create new one
            if (!player) {
                player = {
                    name: playerName,
                    money: 50000, // Starting money
                    shares: {}
                };
                gameState.players.push(player);
                
                // Update player select dropdowns
                updatePlayerSelects();
                
                // Broadcast player update to all clients
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'playerUpdate',
                        player: player
                    }));
                }
            }
            
            return player;
        }

        // Update player select dropdowns
        function updatePlayerSelects() {
            const buyPlayerSelect = document.getElementById('buyPlayerSelect');
            const sellPlayerSelect = document.getElementById('sellPlayerSelect');
            
            if (buyPlayerSelect) {
                buyPlayerSelect.innerHTML = gameState.players.map(player => 
                    `<option value="${player.name}">${player.name} ($${player.money.toFixed(2)})</option>`
                ).join('');
            }
            
            if (sellPlayerSelect) {
                sellPlayerSelect.innerHTML = gameState.players.map(player => 
                    `<option value="${player.name}">${player.name} ($${player.money.toFixed(2)})</option>`
                ).join('');
            }
        }

        // Update players list display
        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            if (!playersList) return;
            
            playersList.innerHTML = gameState.players.map(player => {
                // Calculate portfolio value using current fund prices
                const portfolioValue = player.shares ? Object.entries(player.shares).reduce((total, [fundId, shares]) => {
                    const fund = gameState.funds.find(f => f.id === fundId);
                    return total + (fund ? fund.price * shares : 0);
                }, 0) : 0;
                
                const totalValue = player.money + portfolioValue;
                
                // Calculate value change indicators
                const previousPortfolioValue = player.previousPortfolioValue || portfolioValue;
                const valueChange = portfolioValue - previousPortfolioValue;
                const valueChangeClass = valueChange > 0 ? 'price-up' : valueChange < 0 ? 'price-down' : '';
                const valueChangeArrow = valueChange > 0 ? '↑' : valueChange < 0 ? '↓' : '';
                
                // Store current portfolio value for next comparison
                player.previousPortfolioValue = portfolioValue;
                
                return `
                    <div class="player-item" style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                        <div class="player-header" style="font-weight: bold; margin-bottom: 5px;">
                            ${player.name}
                        </div>
                        <div class="player-values" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 5px;">
                            <div class="value-item">
                                <div class="value-label" style="color: #666; font-size: 0.9em;">Cash</div>
                                <div class="value-amount">$${player.money.toFixed(2)}</div>
                            </div>
                            <div class="value-item">
                                <div class="value-label" style="color: #666; font-size: 0.9em;">Portfolio Value</div>
                                <div class="value-amount ${valueChangeClass}">
                                    $${portfolioValue.toFixed(2)} ${valueChangeArrow}
                                    ${Math.abs(valueChange) > 0 ? ` (${(valueChange > 0 ? '+' : '')}${valueChange.toFixed(2)})` : ''}
                                </div>
                            </div>
                            <div class="value-item">
                                <div class="value-label" style="color: #666; font-size: 0.9em;">Total Value</div>
                                <div class="value-amount" style="font-weight: bold; color: #2196f3;">$${totalValue.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="player-holdings">
                            ${Object.entries(player.shares || {}).map(([fundId, shares]) => {
                                const fund = gameState.funds.find(f => f.id === fundId);
                                if (!fund || shares <= 0) return '';
                                
                                const holdingValue = fund.price * shares;
                                return `
                                    <div class="holding-item" style="margin: 2px 0; padding: 3px; background-color: #fff; border-radius: 4px;">
                                        <span class="fund-name" style="font-weight: bold;">${fund.name}</span>
                                        <span class="holding-details">
                                            ${shares} shares @ $${fund.price.toFixed(2)} = $${holdingValue.toFixed(2)}
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update player select dropdowns with new values
            updatePlayerSelects();
        }
    </script>
    <script src="js/events.js"></script>
</body>
</html>